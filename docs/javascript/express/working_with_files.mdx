---
sidebar_label: "Working with Files"
sidebar_position: 2
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import BrowserWindow from "@site/src/components/BrowserWindow/BrowserWindow";

# Working with Files

When building web applications with Node.js and Express, interacting with the file system is a common requirement. This can range from serving static files to handling user uploads and processing data. Node.js provides a built-in `fs` (File System) module for fundamental file operations, while libraries like `multer` are essential for managing file uploads.

This guide covers common file-related tasks in an Express application, including downloading, uploading, resizing, and deleting files.

## Downloading a File

Express makes it easy to send a file to the client for download using the `res.download()` method. This method sets the `Content-Disposition` header to "attachment," which prompts the browser to download the file instead of displaying it.

The path to the file should be an absolute path or relative to the application's entry point.

```javascript
import express from "express";
import path from "path";

const app = express();

app.get("/download-file", (req, res) => {
  // It's safer to use an absolute path
  const filePath = path.join(__dirname, "my_files", "test.txt");

  res.download(filePath, (err) => {
    if (err) {
      // Handle errors, such as file not found
      res.status(404).send({ message: "File not found." });
    }
  });
});

export default app;
```

## Modifying and Downloading a File

In some cases, you might need to generate or modify a file on the server before sending it to the client. This involves writing to the file system and then initiating a download.

The example below uses `fs.writeFileSync()` for simplicity. In a production environment, it's often better to use the asynchronous `fs.writeFile()` to avoid blocking the event loop.

```javascript
import express from "express";
import fs from "fs";
import path from "path";

const app = express();

app.get("/server-file", (req, res) => {
  const content = "This text was generated by the server.";
  const filePath = path.join(__dirname, "uploads", "server.txt");

  try {
    // Write the content to a file
    fs.writeFileSync(filePath, content, "utf-8");

    // Download the file
    res.download(filePath, (err) => {
      if (err) {
        res.status(500).send({ message: "Could not download the file." });
      }
    });
  } catch (err) {
    res.status(500).send({ message: "Error creating the file." });
  }
});

export default app;
```

## Uploading Files

Handling file uploads requires middleware to process `multipart/form-data`, which is the encoding used for file uploads. `multer` is the most popular middleware for this purpose.

First, install `multer`:

```bash
npm install multer
```

Next, configure `multer` to specify where to store the uploaded files and how to name them.

<Tabs>
<TabItem value="upload.js" label="upload.js">

```javascript
import multer from "multer";
import path from "path";

// Configure disk storage for Multer
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    // The destination is relative to the app's entry point
    cb(null, path.join(__dirname, "uploads/"));
  },
  filename: (req, file, cb) => {
    // Use the original file name
    cb(null, file.originalname);
  },
});

// Create the Multer instance
const upload = multer({ storage: storage });
export default upload;
```

</TabItem>
<TabItem value="app.js" label="app.js">

```javascript
import express from "express";
import upload from "./upload.js";

const app = express();

app.post("/upload-file", upload.single("file"), (req, res) => {
  // The 'file' field in upload.single('file') must match the name attribute
  // of the file input in your HTML form.

  if (!req.file) {
    return res.status(400).send({ message: "Please upload a file." });
  }

  res.status(200).send({
    status: "success",
    message: "File uploaded successfully",
    filename: req.file.filename,
  });
});

export default app;
```

</TabItem>
</Tabs>

## Uploading and Resizing an Image

For image uploads, you often need to resize or process the image before saving it. The `sharp` library is a high-performance tool for image manipulation.

First, install the necessary packages:

```bash
npm install multer sharp
```

To resize an image, it's best to store it in memory first, process it with `sharp`, and then save the final version to disk.

<Tabs>
<TabItem value="resizeImage.js" label="resizeImage.js">

```javascript
import multer from "multer";
import sharp from "sharp";
import path from "path";

// Store the image in memory to process it with sharp
const multerStorage = multer.memoryStorage();

// Filter to allow only image files
const multerFilter = (req, file, cb) => {
  if (file.mimetype.startsWith("image")) {
    cb(null, true);
  } else {
    cb(new Error("Not an image! Please upload only images."), false);
  }
};

const upload = multer({
  storage: multerStorage,
  fileFilter: multerFilter,
});

export const photoUpload = upload.single("photo");

export const resizeImage = async (req, res, next) => {
  if (!req.file) return next();

  req.file.filename = `user-${Date.now()}.jpeg`;
  const outputPath = path.join(__dirname, "uploads", req.file.filename);

  try {
    await sharp(req.file.buffer)
      .resize(500, 500)
      .toFormat("jpeg")
      .jpeg({ quality: 90 })
      .toFile(outputPath);

    next();
  } catch (err) {
    res.status(500).send({ message: "Error resizing the image." });
  }
};
```

</TabItem>
<TabItem value="app.js" label="app.js">

```javascript
import express from "express";
import { photoUpload, resizeImage } from "./resizeImage.js";

const app = express();

app.post("/resize-image", photoUpload, resizeImage, (req, res) => {
  res.status(200).send({
    status: "success",
    message: "Photo uploaded and resized successfully",
    filename: req.file.filename,
  });
});

export default app;
```

</TabItem>
</Tabs>

## Deleting a File

To delete a file from the server, you can use the `fs.unlink()` or `fs.unlinkSync()` method from the Node.js `fs` module. The asynchronous `fs.unlink()` is generally recommended to avoid blocking operations.

Here's how to create an endpoint to delete a file.

```javascript
import express from "express";
import fs from "fs";
import path from "path";

const app = express();

app.delete("/delete-file/:filename", (req, res) => {
  const { filename } = req.params;
  const filePath = path.join(__dirname, "uploads", filename);

  fs.unlink(filePath, (err) => {
    if (err) {
      // Common error is file not found
      if (err.code === 'ENOENT') {
        return res.status(404).send({ message: "File not found." });
      }
      // Other errors
      return res.status(500).send({ message: "Error deleting the file." });
    }

    res.status(200).send({ message: "File deleted successfully." });
  });
});

export default app;
```
